/**
 * Tabelas de percentis do BPA-2 por idade
 * 
 * Dados extraídos do manual oficial BPA-2 (2ª Edição)
 * 
 * Estrutura:
 * - Linhas: Percentis fixos (1, 10, 20, 25, 30, 40, 50, 60, 70, 75, 80, 90, 99)
 * - Células: Escore bruto MÍNIMO para atingir aquele percentil
 * 
 * A busca de percentil funciona assim:
 * Dado um escore, encontrar o maior percentil cujo score mínimo seja <= escore do paciente
 */

export interface PercentileEntry {
  percentile: number;
  score: number;
}

export interface AgePercentileTable {
  AC: PercentileEntry[];
  AD: PercentileEntry[];
  AA: PercentileEntry[];
  AG: PercentileEntry[];
}

// Helper para criar entrada de percentil
const p = (percentile: number, score: number): PercentileEntry => ({ percentile, score });

// Tabela de percentis por idade (dados extraídos do manual BPA-2)
export const BPA2_PERCENTILES: { [age: number]: AgePercentileTable } = {
  // =====================================================
  // IDADE 6 ANOS
  // =====================================================
  6: {
    AC: [
      p(1, -27), p(10, 8), p(20, 16), p(25, 19), p(30, 22), p(40, 25),
      p(50, 28), p(60, 32), p(70, 35), p(75, 37), p(80, 40), p(90, 46), p(99, 79)
    ],
    AD: [
      p(1, -49), p(10, -14), p(20, -1), p(25, 2), p(30, 5), p(40, 17),
      p(50, 26), p(60, 22), p(70, 29), p(75, 32), p(80, 35), p(90, 44), p(99, 72)
    ],
    AA: [
      p(1, -20), p(10, 10), p(20, 18), p(25, 21), p(30, 23), p(40, 26),
      p(50, 31), p(60, 34), p(70, 37), p(75, 39), p(80, 42), p(90, 49), p(99, 78)
    ],
    AG: [
      p(1, -57), p(10, 15), p(20, 34), p(25, 44), p(30, 51), p(40, 63),
      p(50, 73), p(60, 86), p(70, 99), p(75, 105), p(80, 111), p(90, 129), p(99, 207)
    ]
  },

  // =====================================================
  // IDADE 7 ANOS
  // =====================================================
  7: {
    AC: [
      p(1, -21), p(10, 15), p(20, 23), p(25, 26), p(30, 29), p(40, 33),
      p(50, 37), p(60, 40), p(70, 44), p(75, 46), p(80, 48), p(90, 55), p(99, 70)
    ],
    AD: [
      p(1, -53), p(10, -9), p(20, 4), p(25, 9), p(30, 13), p(40, 34),
      p(50, 26), p(60, 31), p(70, 37), p(75, 40), p(80, 43), p(90, 51), p(99, 72)
    ],
    AA: [
      p(1, -16), p(10, 17), p(20, 25), p(25, 28), p(30, 30), p(40, 34),
      p(50, 38), p(60, 42), p(70, 46), p(75, 48), p(80, 51), p(90, 59), p(99, 83)
    ],
    AG: [
      p(1, -42), p(10, 32), p(20, 59), p(25, 68), p(30, 76), p(40, 89),
      p(50, 99), p(60, 110), p(70, 122), p(75, 129), p(80, 135), p(90, 153), p(99, 206)
    ]
  },

  // =====================================================
  // IDADE 8 ANOS
  // =====================================================
  8: {
    AC: [
      p(1, -13), p(10, 22), p(20, 31), p(25, 33), p(30, 36), p(40, 40),
      p(50, 44), p(60, 47), p(70, 52), p(75, 54), p(80, 56), p(90, 62), p(99, 79)
    ],
    AD: [
      p(1, -47), p(10, 1), p(20, 15), p(25, 20), p(30, 23), p(40, 40),
      p(50, 52), p(60, 40), p(70, 44), p(75, 48), p(80, 51), p(90, 60), p(99, 77)
    ],
    AA: [
      p(1, -6), p(10, 24), p(20, 33), p(25, 35), p(30, 37), p(40, 42),
      p(50, 46), p(60, 50), p(70, 55), p(75, 59), p(80, 62), p(90, 72), p(99, 94)
    ],
    AG: [
      p(1, -30), p(10, 57), p(20, 83), p(25, 94), p(30, 100), p(40, 112),
      p(50, 124), p(60, 135), p(70, 146), p(75, 154), p(80, 162), p(90, 182), p(99, 230)
    ]
  },

  // =====================================================
  // IDADE 9 ANOS
  // =====================================================
  9: {
    AC: [
      p(1, -14), p(10, 28), p(20, 37), p(25, 40), p(30, 42), p(40, 46),
      p(50, 50), p(60, 54), p(70, 59), p(75, 62), p(80, 64), p(90, 70), p(99, 89)
    ],
    AD: [
      p(1, -47), p(10, 4), p(20, 20), p(25, 24), p(30, 28), p(40, 46),
      p(50, 57), p(60, 46), p(70, 52), p(75, 55), p(80, 58), p(90, 68), p(99, 93)
    ],
    AA: [
      p(1, 0), p(10, 30), p(20, 39), p(25, 41), p(30, 44), p(40, 48),
      p(50, 53), p(60, 58), p(70, 64), p(75, 68), p(80, 72), p(90, 82), p(99, 109)
    ],
    AG: [
      p(1, -10), p(10, 74), p(20, 100), p(25, 110), p(30, 118), p(40, 131),
      p(50, 143), p(60, 155), p(70, 169), p(75, 177), p(80, 186), p(90, 208), p(99, 271)
    ]
  },

  // =====================================================
  // IDADE 10 ANOS
  // =====================================================
  10: {
    AC: [
      p(1, -15), p(10, 32), p(20, 42), p(25, 45), p(30, 48), p(40, 52),
      p(50, 56), p(60, 60), p(70, 65), p(75, 68), p(80, 71), p(90, 78), p(99, 99)
    ],
    AD: [
      p(1, -43), p(10, 7), p(20, 24), p(25, 29), p(30, 33), p(40, 52),
      p(50, 57), p(60, 58), p(70, 62), p(75, 65), p(80, 65), p(90, 73), p(99, 95)
    ],
    AA: [
      p(1, -6), p(10, 33), p(20, 43), p(25, 47), p(30, 49), p(40, 55),
      p(50, 61), p(60, 68), p(70, 74), p(75, 78), p(80, 82), p(90, 93), p(99, 114)
    ],
    AG: [
      p(1, -22), p(10, 83), p(20, 115), p(25, 126), p(30, 135), p(40, 150),
      p(50, 164), p(60, 177), p(70, 192), p(75, 200), p(80, 208), p(90, 231), p(99, 283)
    ]
  },

  // =====================================================
  // IDADE 11 ANOS
  // =====================================================
  11: {
    AC: [
      p(1, -1), p(10, 37), p(20, 46), p(25, 49), p(30, 52), p(40, 57),
      p(50, 61), p(60, 66), p(70, 72), p(75, 75), p(80, 78), p(90, 87), p(99, 110)
    ],
    AD: [
      p(1, -36), p(10, 15), p(20, 31), p(25, 35), p(30, 38), p(40, 58),
      p(50, 64), p(60, 64), p(70, 67), p(75, 70), p(80, 81), p(90, 106), p(99, 106)
    ],
    AA: [
      p(1, -8), p(10, 39), p(20, 49), p(25, 53), p(30, 57), p(40, 62),
      p(50, 70), p(60, 76), p(70, 82), p(75, 87), p(80, 90), p(90, 101), p(99, 117)
    ],
    AG: [
      p(1, -19), p(10, 104), p(20, 133), p(25, 143), p(30, 153), p(40, 168),
      p(50, 183), p(60, 196), p(70, 212), p(75, 221), p(80, 231), p(90, 257), p(99, 311)
    ]
  },

  // =====================================================
  // IDADE 12 ANOS
  // =====================================================
  12: {
    AC: [
      p(1, -5), p(10, 41), p(20, 51), p(25, 55), p(30, 58), p(40, 64),
      p(50, 69), p(60, 74), p(70, 80), p(75, 83), p(80, 86), p(90, 95), p(99, 113)
    ],
    AD: [
      p(1, -31), p(10, 19), p(20, 34), p(25, 39), p(30, 43), p(40, 60),
      p(50, 67), p(60, 70), p(70, 74), p(75, 78), p(80, 88), p(90, 106), p(99, 106)
    ],
    AA: [
      p(1, -6), p(10, 42), p(20, 55), p(25, 59), p(30, 63), p(40, 71),
      p(50, 77), p(60, 84), p(70, 91), p(75, 95), p(80, 100), p(90, 108), p(99, 119)
    ],
    AG: [
      p(1, -9), p(10, 114), p(20, 149), p(25, 160), p(30, 170), p(40, 188),
      p(50, 203), p(60, 219), p(70, 236), p(75, 245), p(80, 254), p(90, 278), p(99, 320)
    ]
  },

  // =====================================================
  // IDADE 13 ANOS
  // =====================================================
  13: {
    AC: [
      p(1, 4), p(10, 42), p(20, 53), p(25, 57), p(30, 60), p(40, 67),
      p(50, 73), p(60, 79), p(70, 84), p(75, 88), p(80, 91), p(90, 101), p(99, 118)
    ],
    AD: [
      p(1, -30), p(10, 21), p(20, 37), p(25, 42), p(30, 45), p(40, 67),
      p(50, 74), p(60, 74), p(70, 78), p(75, 82), p(80, 92), p(90, 110), p(99, 110)
    ],
    AA: [
      p(1, 9), p(10, 42), p(20, 58), p(25, 63), p(30, 68), p(40, 75),
      p(50, 81), p(60, 88), p(70, 96), p(75, 99), p(80, 103), p(90, 112), p(99, 120)
    ],
    AG: [
      p(1, 25), p(10, 121), p(20, 153), p(25, 169), p(30, 179), p(40, 197),
      p(50, 212), p(60, 230), p(70, 250), p(75, 259), p(80, 269), p(90, 290), p(99, 330)
    ]
  },

  // =====================================================
  // IDADE 14 ANOS
  // =====================================================
  14: {
    AC: [
      p(1, 1), p(10, 47), p(20, 57), p(25, 60), p(30, 63), p(40, 70),
      p(50, 77), p(60, 83), p(70, 90), p(75, 93), p(80, 97), p(90, 108), p(99, 115)
    ],
    AD: [
      p(1, -27), p(10, 29), p(20, 42), p(25, 46), p(30, 51), p(40, 76),
      p(50, 82), p(60, 81), p(70, 84), p(75, 88), p(80, 97), p(90, 114), p(99, 114)
    ],
    AA: [
      p(1, 10), p(10, 50), p(20, 63), p(25, 68), p(30, 72), p(40, 79),
      p(50, 86), p(60, 93), p(70, 100), p(75, 104), p(80, 107), p(90, 114), p(99, 120)
    ],
    AG: [
      p(1, 30), p(10, 142), p(20, 172), p(25, 185), p(30, 194), p(40, 210),
      p(50, 228), p(60, 245), p(70, 264), p(75, 273), p(80, 282), p(90, 303), p(99, 339)
    ]
  }
};

// =====================================================
// FAIXAS ETÁRIAS AGRUPADAS (conforme manual BPA-2)
// =====================================================

// 15-17 anos
const TABLE_15_17: AgePercentileTable = {
  AC: [
    p(1, 10), p(10, 48), p(20, 62), p(25, 66), p(30, 69), p(40, 76),
    p(50, 83), p(60, 89), p(70, 96), p(75, 99), p(80, 103), p(90, 112), p(99, 113)
  ],
  AD: [
    p(1, -11), p(10, 34), p(20, 50), p(25, 56), p(30, 60), p(40, 86),
    p(50, 92), p(60, 89), p(70, 92), p(75, 96), p(80, 104), p(90, 116), p(99, 116)
  ],
  AA: [
    p(1, 5), p(10, 55), p(20, 70), p(25, 75), p(30, 80), p(40, 87),
    p(50, 94), p(60, 100), p(70, 107), p(75, 110), p(80, 113), p(90, 117), p(99, 120)
  ],
  AG: [
    p(1, 41), p(10, 150), p(20, 188), p(25, 205), p(30, 216), p(40, 235),
    p(50, 250), p(60, 267), p(70, 282), p(75, 291), p(80, 300), p(90, 320), p(99, 347)
  ]
};

for (let age = 15; age <= 17; age++) {
  BPA2_PERCENTILES[age] = TABLE_15_17;
}

// 18-20 anos
const TABLE_18_20: AgePercentileTable = {
  AC: [
    p(1, 34), p(10, 63), p(20, 73), p(25, 77), p(30, 80), p(40, 86),
    p(50, 92), p(60, 98), p(70, 104), p(75, 108), p(80, 112), p(90, 118), p(99, 120)
  ],
  AD: [
    p(1, 16), p(10, 53), p(20, 66), p(25, 70), p(30, 74), p(40, 92),
    p(50, 88), p(60, 98), p(70, 100), p(75, 104), p(80, 110), p(90, 120), p(99, 120)
  ],
  AA: [
    p(1, 36), p(10, 69), p(20, 80), p(25, 84), p(30, 88), p(40, 95),
    p(50, 100), p(60, 107), p(70, 112), p(75, 114), p(80, 116), p(90, 119), p(99, 120)
  ],
  AG: [
    p(1, 118), p(10, 185), p(20, 226), p(25, 237), p(30, 247), p(40, 264),
    p(50, 278), p(60, 292), p(70, 305), p(75, 312), p(80, 319), p(90, 335), p(99, 356)
  ]
};

for (let age = 18; age <= 20; age++) {
  BPA2_PERCENTILES[age] = TABLE_18_20;
}

// 21-30 anos
const TABLE_21_30: AgePercentileTable = {
  AC: [
    p(1, 33), p(10, 62), p(20, 72), p(25, 76), p(30, 79), p(40, 85),
    p(50, 91), p(60, 97), p(70, 103), p(75, 106), p(80, 110), p(90, 118), p(99, 120)
  ],
  AD: [
    p(1, 8), p(10, 49), p(20, 60), p(25, 65), p(30, 69), p(40, 82),
    p(50, 88), p(60, 94), p(70, 97), p(75, 100), p(80, 108), p(90, 119), p(99, 119)
  ],
  AA: [
    p(1, 28), p(10, 62), p(20, 73), p(25, 77), p(30, 81), p(40, 88),
    p(50, 95), p(60, 100), p(70, 106), p(75, 109), p(80, 113), p(90, 118), p(99, 120)
  ],
  AG: [
    p(1, 99), p(10, 169), p(20, 214), p(25, 224), p(30, 234), p(40, 251),
    p(50, 266), p(60, 281), p(70, 296), p(75, 304), p(80, 312), p(90, 330), p(99, 354)
  ]
};

for (let age = 21; age <= 30; age++) {
  BPA2_PERCENTILES[age] = TABLE_21_30;
}

// 31-40 anos
const TABLE_31_40: AgePercentileTable = {
  AC: [
    p(1, 28), p(10, 61), p(20, 70), p(25, 74), p(30, 78), p(40, 84),
    p(50, 90), p(60, 95), p(70, 102), p(75, 105), p(80, 108), p(90, 116), p(99, 120)
  ],
  AD: [
    p(1, 0), p(10, 42), p(20, 53), p(25, 58), p(30, 61), p(40, 75),
    p(50, 81), p(60, 88), p(70, 91), p(75, 95), p(80, 105), p(90, 118), p(99, 118)
  ],
  AA: [
    p(1, 15), p(10, 55), p(20, 66), p(25, 71), p(30, 74), p(40, 81),
    p(50, 87), p(60, 94), p(70, 100), p(75, 104), p(80, 108), p(90, 116), p(99, 120)
  ],
  AG: [
    p(1, 82), p(10, 144), p(20, 198), p(25, 208), p(30, 218), p(40, 236),
    p(50, 251), p(60, 267), p(70, 283), p(75, 292), p(80, 301), p(90, 322), p(99, 352)
  ]
};

for (let age = 31; age <= 40; age++) {
  BPA2_PERCENTILES[age] = TABLE_31_40;
}

// 41-50 anos
const TABLE_41_50: AgePercentileTable = {
  AC: [
    p(1, 24), p(10, 57), p(20, 67), p(25, 70), p(30, 73), p(40, 80),
    p(50, 85), p(60, 91), p(70, 98), p(75, 102), p(80, 106), p(90, 103), p(99, 91)
  ],
  AD: [
    p(1, -9), p(10, 31), p(20, 43), p(25, 47), p(30, 51), p(40, 64),
    p(50, 70), p(60, 78), p(70, 82), p(75, 86), p(80, 96), p(90, 116), p(99, 116)
  ],
  AA: [
    p(1, 1), p(10, 45), p(20, 57), p(25, 61), p(30, 65), p(40, 72),
    p(50, 78), p(60, 85), p(70, 93), p(75, 97), p(80, 101), p(90, 112), p(99, 120)
  ],
  AG: [
    p(1, 53), p(10, 120), p(20, 173), p(25, 184), p(30, 194), p(40, 212),
    p(50, 228), p(60, 245), p(70, 263), p(75, 272), p(80, 283), p(90, 308), p(99, 347)
  ]
};

for (let age = 41; age <= 50; age++) {
  BPA2_PERCENTILES[age] = TABLE_41_50;
}

// 51-60 anos
const TABLE_51_60: AgePercentileTable = {
  AC: [
    p(1, 14), p(10, 51), p(20, 61), p(25, 65), p(30, 68), p(40, 74),
    p(50, 81), p(60, 87), p(70, 94), p(75, 98), p(80, 103), p(90, 107), p(99, 68)
  ],
  AD: [
    p(1, -19), p(10, 21), p(20, 34), p(25, 38), p(30, 42), p(40, 54),
    p(50, 61), p(60, 68), p(70, 72), p(75, 77), p(80, 88), p(90, 112), p(99, 112)
  ],
  AA: [
    p(1, 0), p(10, 36), p(20, 47), p(25, 52), p(30, 56), p(40, 63),
    p(50, 70), p(60, 77), p(70, 85), p(75, 89), p(80, 95), p(90, 106), p(99, 117)
  ],
  AG: [
    p(1, 32), p(10, 89), p(20, 149), p(25, 160), p(30, 171), p(40, 188),
    p(50, 206), p(60, 224), p(70, 242), p(75, 253), p(80, 264), p(90, 292), p(99, 338)
  ]
};

for (let age = 51; age <= 60; age++) {
  BPA2_PERCENTILES[age] = TABLE_51_60;
}

// 61-70 anos
const TABLE_61_70: AgePercentileTable = {
  AC: [
    p(1, 10), p(10, 43), p(20, 53), p(25, 56), p(30, 60), p(40, 67),
    p(50, 72), p(60, 79), p(70, 85), p(75, 89), p(80, 94), p(90, 107), p(99, 116)
  ],
  AD: [
    p(1, -32), p(10, 9), p(20, 22), p(25, 27), p(30, 31), p(40, 44),
    p(50, 51), p(60, 57), p(70, 62), p(75, 66), p(80, 77), p(90, 104), p(99, 104)
  ],
  AA: [
    p(1, -5), p(10, 26), p(20, 36), p(25, 39), p(30, 43), p(40, 50),
    p(50, 57), p(60, 64), p(70, 72), p(75, 76), p(80, 81), p(90, 93), p(99, 110)
  ],
  AG: [
    p(1, 7), p(10, 47), p(20, 116), p(25, 127), p(30, 138), p(40, 156),
    p(50, 174), p(60, 192), p(70, 213), p(75, 223), p(80, 233), p(90, 259), p(99, 318)
  ]
};

for (let age = 61; age <= 70; age++) {
  BPA2_PERCENTILES[age] = TABLE_61_70;
}

// 71-80 anos
const TABLE_71_80: AgePercentileTable = {
  AC: [
    p(1, 6), p(10, 28), p(20, 38), p(25, 42), p(30, 46), p(40, 52),
    p(50, 58), p(60, 65), p(70, 71), p(75, 76), p(80, 81), p(90, 91), p(99, 68)
  ],
  AD: [
    p(1, -31), p(10, 0), p(20, 10), p(25, 14), p(30, 17), p(40, 28),
    p(50, 33), p(60, 41), p(70, 45), p(75, 48), p(80, 60), p(90, 90), p(99, 90)
  ],
  AA: [
    p(1, -15), p(10, 14), p(20, 23), p(25, 26), p(30, 30), p(40, 35),
    p(50, 41), p(60, 48), p(70, 55), p(75, 59), p(80, 64), p(90, 78), p(99, 78)
  ],
  AG: [
    p(1, -12), p(10, 18), p(20, 77), p(25, 87), p(30, 95), p(40, 111),
    p(50, 126), p(60, 145), p(70, 166), p(75, 175), p(80, 186), p(90, 222), p(99, 290)
  ]
};

for (let age = 71; age <= 80; age++) {
  BPA2_PERCENTILES[age] = TABLE_71_80;
}

// 81+ anos
const TABLE_81: AgePercentileTable = {
  AC: [
    p(1, 15), p(10, 15), p(20, 23), p(25, 28), p(30, 31), p(40, 37),
    p(50, 43), p(60, 48), p(70, 53), p(75, 56), p(80, 60), p(90, 107), p(99, 120)
  ],
  AD: [
    p(1, -53), p(10, -5), p(20, 0), p(25, 3), p(30, 5), p(40, 15),
    p(50, 20), p(60, 25), p(70, 29), p(75, 32), p(80, 42), p(90, 68), p(99, 68)
  ],
  AA: [
    p(1, -23), p(10, 4), p(20, 14), p(25, 17), p(30, 21), p(40, 26),
    p(50, 30), p(60, 33), p(70, 39), p(75, 41), p(80, 44), p(90, 56), p(99, 120)
  ],
  AG: [
    p(1, -21), p(10, 38), p(20, 45), p(25, 53), p(30, 60), p(40, 72),
    p(50, 85), p(60, 97), p(70, 114), p(75, 126), p(80, 133), p(90, 158), p(99, 222)
  ]
};

BPA2_PERCENTILES[81] = TABLE_81;

/**
 * Busca o percentil para um escore em uma determinada idade e subteste
 * 
 * Lógica: Encontrar o maior percentil cujo score mínimo seja <= escore do paciente
 * 
 * Exemplo:
 * - Paciente: 56 anos, AA = 70
 * - Tabela 51-60 anos AA: P50=70, P60=77
 * - 70 >= 70 (P50) e 70 < 77 (P60)
 * - Resultado: Percentil 50
 */
export const lookupPercentile = (
  age: number, 
  subtest: 'AC' | 'AD' | 'AA' | 'AG', 
  score: number
): number => {
  // Limitar idade aos valores disponíveis (6-81)
  const clampedAge = Math.min(81, Math.max(6, age));
  
  const table = BPA2_PERCENTILES[clampedAge];
  if (!table) return 1;
  
  const entries = table[subtest];
  if (!entries || entries.length === 0) return 1;
  
  // Percorrer do maior percentil para o menor
  // Encontrar o maior percentil cujo score mínimo seja <= escore do paciente
  for (let i = entries.length - 1; i >= 0; i--) {
    if (score >= entries[i].score) {
      return entries[i].percentile;
    }
  }
  
  // Se o escore for menor que todos os scores mínimos, retorna percentil 1
  return 1;
};

/**
 * Retorna a faixa de idade correspondente para exibição
 */
export const getAgeGroup = (age: number): string => {
  if (age <= 14) return `${age} anos`;
  if (age <= 17) return '15-17 anos';
  if (age <= 20) return '18-20 anos';
  if (age <= 30) return '21-30 anos';
  if (age <= 40) return '31-40 anos';
  if (age <= 50) return '41-50 anos';
  if (age <= 60) return '51-60 anos';
  if (age <= 70) return '61-70 anos';
  if (age <= 80) return '71-80 anos';
  return '81+ anos';
};
